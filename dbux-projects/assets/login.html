<head>
  <title>Dbux Login</title>
  <script src="https://cdn.jsdelivr.net/npm/socket.io-client@2.3.0/dist/socket.io.js"></script>
</head>

<body>
  <script src="https://www.gstatic.com/firebasejs/7.17.1/firebase.js"></script>
  <script>

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyC-d0HDLJ8Gd9UZ175z7dg6J98ZrOIK0Mc",
      authDomain: "learn-learn-b8e5a.firebaseapp.com",
      databaseURL: "https://learn-learn-b8e5a.firebaseio.com",
      projectId: "learn-learn-b8e5a",
      storageBucket: "learn-learn-b8e5a.appspot.com",
      messagingSenderId: "249308200308",
      appId: "1:249308200308:web:07556e84184b4546ef8021"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();

    auth.onAuthStateChanged(user => {
      // if (user) {
      //   console.log(user);
      //   loginSuccess(user);
      // }
      // else {
        firebase.auth().getRedirectResult().then((result) => {
          if (result && result.user) {
            loginSuccess(result);
          }
          else {
            doLogin();
          }
        });
      // }
    });

    function doLogin() {
      const provider = new firebase.auth.GoogleAuthProvider();
      firebase.auth().signInWithRedirect(provider);
    }

    function loginSuccess(result) {
      document.querySelector('#message').textContent = `Success! Logged in as ${result.user.displayName}.`;
      const accessToken = result.credential.accessToken;
      console.log(accessToken);
      // result.user.getIdToken().then(console.log);
      sendData(accessToken);
    }

    function sendData(accessToken) {
      const port = 9891;
      const Remote = `ws://localhost:${port}`;
      const socket = io.connect(Remote, {
        port, 
        transports: ['websocket'],
      });
      
      socket.on('connect', () => {
        console.log('connected');
        socket.emit('accessToken', accessToken)
      });
      socket.on('connect_error', () => console.log('connection failed'));
      socket.on('disconnect', () => console.log('Server disconnected'));
      socket.on('error', (err) => console.log('Error:', err));
      socket.on('reconnect_attempt', () => console.log('reconnecting...'));
      socket.on('ack', () => {
        socket.emit('acked');
        document.getElementById('message').innerHTML += `<br>You may close this tab.`
      });
    }
  </script>

  <div id="message">
    Logging in with Google...
  </div>
  <!-- <button onclick="login()">Login with Google...</button> -->
</body>